<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy-CloudDrive API 自动化测试</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        .status-pending { color: #6b7280; }
        .status-running { color: #3b82f6; font-weight: bold; }
        .status-success { color: #10b981; font-weight: bold; }
        .status-failure { color: #ef4444; font-weight: bold; }
        .log-entry { border-bottom: 1px solid #e5e7eb; padding: 0.5rem 0; }
        .log-details { background-color: #f9fafb; padding: 0.5rem; margin-top: 0.25rem; border-radius: 0.25rem; font-size: 0.875rem; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div id="app" class="container mx-auto bg-white p-8 rounded-lg shadow-md">
        <h1 class="text-3xl font-bold mb-6 text-indigo-600">API 自动化测试</h1>

        <button @click="runAllTests" :disabled="isRunning" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded mb-6 disabled:opacity-50">
            {{ isRunning ? '正在运行...' : '运行所有测试' }}
        </button>

        <div class="test-results">
            <h2 class="text-2xl font-semibold mb-4">测试结果</h2>
            <div v-if="!tests.length && !isRunning" class="text-gray-500">点击按钮开始测试。</div>
            <div v-for="(test, index) in tests" :key="index" class="log-entry">
                <div class="flex justify-between items-center">
                    <span class="font-medium">{{ test.name }}</span>
                    <span :class="['status-' + test.status]">{{ test.status.toUpperCase() }}</span>
                </div>
                <div v-if="test.message" class="log-details">
                    <strong>{{ test.status === 'failure' ? '错误' : '详情' }}:</strong> {{ test.message }}
                </div>
                 <div v-if="test.duration !== null" class="text-xs text-gray-500 mt-1">
                    耗时: {{ test.duration }} ms
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                tests: [],
                isRunning: false
            },
            methods: {
                async runAllTests() {
                    if (this.isRunning) return;
                    this.isRunning = true;
                    this.tests = []; // 清空上次结果

                    // --- 测试配置 ---
                    const testFolderName = `test-folder-${Date.now()}`;
                    const testFolderPath = `${testFolderName}/`;
                    const testFileName = `test-file-${Date.now()}.txt`;
                    const testFilePath = `${testFolderPath}${testFileName}`;
                    const testFileContent = `Test content created at ${new Date().toISOString()}`;
                    const testFileURL = 'https://raw.githubusercontent.com/axios/axios/main/README.md'; // 用一个小的公开文件测试URL上传
                    const renamedFileName = `renamed-${testFileName}`;
                    const renamedFilePath = `${testFolderPath}${renamedFileName}`;

                    // --- 测试定义 ---
                    const testSuite = [
                        { name: '创建测试文件夹', func: this.testCreateFolder, params: [testFolderPath] },
                        { name: '列出测试文件夹 (空)', func: this.testListFolder, params: [testFolderPath, true] },
                        { name: '通过 URL 上传测试文件', func: this.testUploadByUrl, params: [testFileURL, testFolderPath, testFileName] },
                        { name: '列出测试文件夹 (包含文件)', func: this.testListFolder, params: [testFolderPath, false, testFileName] },
                        { name: '搜索测试文件', func: this.testSearchFile, params: [testFileName, testFolderPath] },
                        { name: '重命名测试文件', func: this.testRenameFile, params: [testFilePath, renamedFilePath] },
                        { name: '列出测试文件夹 (验证重命名)', func: this.testListFolder, params: [testFolderPath, false, renamedFileName, testFileName] },
                        { name: '预览重命名的文件', func: this.testPreviewFile, params: [renamedFilePath] },
                        { name: '分享重命名的文件', func: this.testShareFile, params: [renamedFilePath] },
                        { name: '删除重命名的文件', func: this.testDeleteFile, params: [renamedFilePath] },
                        { name: '列出测试文件夹 (文件已删除)', func: this.testListFolder, params: [testFolderPath, true] },
                        { name: '删除测试文件夹', func: this.testDeleteFile, params: [testFolderPath] },
                        // { name: '列出根目录 (验证文件夹已删除)', func: this.testListRootAfterDelete, params: [testFolderPath] } // 可选，验证根目录
                    ];

                    // --- 运行测试 ---
                    for (const test of testSuite) {
                        await this.runTest(test.name, test.func, ...test.params);
                    }

                    this.isRunning = false;
                },

                logTest(name, status, message = null, duration = null) {
                    const existingTest = this.tests.find(t => t.name === name);
                    if (existingTest) {
                        existingTest.status = status;
                        existingTest.message = message;
                        existingTest.duration = duration;
                    } else {
                        this.tests.push({ name, status, message, duration });
                    }
                },

                async runTest(testName, testFunc, ...params) {
                    this.logTest(testName, 'running');
                    const startTime = performance.now();
                    let duration = null;
                    try {
                        await testFunc(...params);
                        duration = (performance.now() - startTime).toFixed(2);
                        this.logTest(testName, 'success', null, duration);
                    } catch (error) {
                        duration = (performance.now() - startTime).toFixed(2);
                        console.error(`Test "${testName}" failed:`, error);
                        this.logTest(testName, 'failure', error.message || '未知错误', duration);
                        // 如果一个测试失败，可以选择停止后续测试
                        // throw new Error(`Test "${testName}" failed, stopping suite.`);
                    }
                     // 添加短暂延迟，避免请求过于频繁
                    await new Promise(resolve => setTimeout(resolve, 100));
                },

                // --- 单个 API 测试函数 ---

                async testCreateFolder(folderPath) {
                    const response = await fetch('/createFolder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folderPath })
                    });
                    if (!response.ok) throw new Error(`创建文件夹失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    if (!data.message || !data.message.includes('成功')) throw new Error(`创建文件夹响应异常: ${JSON.stringify(data)}`);
                },

                async testListFolder(folderPath, isEmpty, expectedFileName = null, unexpectedFileName = null) {
                    const response = await fetch(`/getfilelist?path=${encodeURIComponent(folderPath)}&pageSize=10`);
                    if (!response.ok) throw new Error(`列出文件夹失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    const files = data.files || [];

                    if (isEmpty && files.length !== 0) {
                        throw new Error(`预期文件夹 '${folderPath}' 为空，但找到 ${files.length} 个项目: ${JSON.stringify(files.map(f => f.name))}`);
                    }
                    if (!isEmpty && files.length === 0) {
                        throw new Error(`预期文件夹 '${folderPath}' 不为空，但列表为空`);
                    }
                    if (expectedFileName) {
                        const found = files.some(f => f.relativeName === expectedFileName);
                        if (!found) throw new Error(`预期在 '${folderPath}' 中找到文件 '${expectedFileName}'，但未找到`);
                    }
                    if (unexpectedFileName) {
                         const found = files.some(f => f.relativeName === unexpectedFileName);
                         if (found) throw new Error(`不应在 '${folderPath}' 中找到文件 '${unexpectedFileName}'，但它存在`);
                    }
                },

                 async testUploadByUrl(url, path, fileName) {
                    const response = await fetch('/uploadbyurl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, path, fileName })
                    });
                    if (!response.ok) throw new Error(`URL上传失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    if (!data.message || !data.message.includes('成功')) throw new Error(`URL上传响应异常: ${JSON.stringify(data)}`);
                },

                async testSearchFile(query, path) {
                    const response = await fetch(`/searchFiles?query=${encodeURIComponent(query)}&path=${encodeURIComponent(path)}`);
                     if (!response.ok) throw new Error(`搜索文件失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    if (!data.results || data.results.length === 0) throw new Error(`搜索 '${query}' 未找到结果`);
                    const found = data.results.some(f => f.fileName === query && f.path === path);
                    if (!found) throw new Error(`搜索结果中未找到精确匹配的文件 '${path}${query}'`);
                },

                 async testRenameFile(oldFileName, newFileName) {
                    const response = await fetch('/renameFile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ oldFileName, newFileName })
                    });
                    if (!response.ok) throw new Error(`重命名文件失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    if (!data.message || !data.message.includes('成功')) throw new Error(`重命名响应异常: ${JSON.stringify(data)}`);
                },

                async testPreviewFile(filePath) {
                    const response = await fetch(`/previewFile?file=${encodeURIComponent(filePath)}`);
                    if (!response.ok) throw new Error(`预览文件失败: ${response.status} ${await response.text()}`);
                    const contentType = response.headers.get('Content-Type');
                    if (!contentType || !contentType.startsWith('text/markdown')) { // 基于测试URL是README.md
                        console.warn(`预览文件 '${filePath}' 的 Content-Type 为 '${contentType}'，可能与预期不符，但测试通过`);
                    }
                    // 可以添加更多对内容的检查，但对于自动化测试来说可能过于复杂
                },

                 async testShareFile(filePath) {
                    const response = await fetch('/shareFile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filePath, expirationDays: 1, requirePassword: false })
                    });
                    if (!response.ok) throw new Error(`分享文件失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    if (!data.shareUrl || typeof data.shareUrl !== 'string' || !data.shareUrl.startsWith('http')) {
                         throw new Error(`分享文件响应异常，未返回有效的 shareUrl: ${JSON.stringify(data)}`);
                    }
                },

                async testDeleteFile(filePath) {
                    const response = await fetch(`/deleteFile?path=${encodeURIComponent(filePath)}`, {
                        method: 'DELETE'
                    });
                     if (!response.ok) throw new Error(`删除 '${filePath}' 失败: ${response.status} ${await response.text()}`);
                    const data = await response.json();
                    if (!data.message || !data.message.includes('成功')) throw new Error(`删除响应异常: ${JSON.stringify(data)}`);
                },

                // 可选：检查根目录是否清除了测试文件夹
                // async testListRootAfterDelete(deletedFolderPath) {
                //     const response = await fetch(`/getfilelist?path=&pageSize=500`); // 假设根目录文件不多
                //     if (!response.ok) throw new Error(`列出根目录失败: ${response.status} ${await response.text()}`);
                //     const data = await response.json();
                //     const found = (data.files || []).some(f => f.name === deletedFolderPath);
                //     if (found) throw new Error(`测试文件夹 '${deletedFolderPath}' 删除后仍然存在于根目录`);
                // }
            }
        });
    </script>
</body>
</html> 